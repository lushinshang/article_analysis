import re
import shutil
from pathlib import Path
from typing import List
import typer
import markdown
from rich.console import Console
from rich.markdown import Markdown
from rich.panel import Panel

app = typer.Typer()
console = Console()

class ReportConductor:
    """
    è² è²¬è™•ç† AI 2026 å±•æœ›å ±å‘Šçš„é¡åˆ¥ã€‚
    """
    def __init__(self, file_path: str):
        self.file_path = Path(file_path)
        if not self.file_path.exists():
            raise FileNotFoundError(f"æ‰¾ä¸åˆ°å ±å‘Šæª”æ¡ˆï¼š{file_path}")
        self.content = self.file_path.read_text(encoding='utf-8')

    def get_summary(self) -> str:
        """æå–åŸ·è¡Œæ‘˜è¦å€å¡Šã€‚"""
        pattern = r"## ğŸ“‹ å ±å‘Šæ‘˜è¦\n\n(.*?)\n---"
        match = re.search(pattern, self.content, re.DOTALL)
        return match.group(1).strip() if match else "æœªæ‰¾åˆ°æ‘˜è¦ã€‚"

    def extract_mermaid_charts(self) -> List[str]:
        """æå–æ‰€æœ‰ Mermaid åœ–è¡¨å®šç¾©ã€‚"""
        pattern = r"```mermaid\n(.*?)\n```"
        return re.findall(pattern, self.content, re.DOTALL)

    def list_experts(self) -> List[str]:
        """æå–ä»‹ç´¹ä¸­æåˆ°çš„å°ˆå®¶å§“åã€‚"""
        pattern = r"Hopes for 2026 from (.*?)\""
        match = re.search(pattern, self.content)
        if match:
            raw_names = match.group(1).split(',')
            return [name.strip() for name in raw_names]
        return []

    def get_action_items(self) -> str:
        """æå–ä¸‹ä¸€æ­¥è¡Œå‹•å»ºè­°ã€‚"""
        pattern = r"\*\*ä¸‹ä¸€æ­¥è¡Œå‹•\*\*:(.*?)\n---"
        match = re.search(pattern, self.content, re.DOTALL)
        return match.group(1).strip() if match else "æœªæ‰¾åˆ°è¡Œå‹•å»ºè­°ã€‚"

    def convert_to_folder(self, slug: str) -> Path:
        """å°‡ Markdown è½‰æ›ç‚º HTML ä¸¦è¼¸å‡ºåˆ°æŒ‡å®šç›®éŒ„ï¼ŒåŒæ™‚é›†ä¸­åœ–ç‰‡ã€‚"""
        output_dir = Path(f"output/{slug}")
        output_dir.mkdir(parents=True, exist_ok=True)
        
        content = self.content
        
        # è™•ç†åœ–ç‰‡ï¼šè¤‡è£½ä¸¦æ›´æ–°è·¯å¾‘
        def replace_image(match):
            alt_text = match.group(1)
            img_path_str = match.group(2)
            
            # å¿½ç•¥ç¶²è·¯åœ–ç‰‡
            if img_path_str.startswith('http') or img_path_str.startswith('https'):
                return match.group(0)
                
            img_path = Path(img_path_str)
            # å‡è¨­åœ–ç‰‡è·¯å¾‘ç›¸å°æ–¼ Markdown æª”æ¡ˆ
            abs_img_path = (self.file_path.parent / img_path).resolve()
            
            if abs_img_path.exists():
                dest_path = output_dir / abs_img_path.name
                shutil.copy2(abs_img_path, dest_path)
                return f'![{alt_text}]({abs_img_path.name})'
            else:
                return match.group(0)

        new_content = re.sub(r'!\[(.*?)\]\((.*?)\)', replace_image, content)
        
        # é è™•ç†ï¼šç¢ºä¿åˆ—è¡¨å‰æœ‰ç©ºè¡Œ (Markdown æ¨™æº–è¦æ±‚)ï¼Œè™•ç†ã€Œ-ã€ã€Œ1.ã€ã€Œ*ã€ç­‰åˆ†é»
        new_content = re.sub(r'(?<!\n)\n(?=[ \t]*([-*+]|\d+\.)[ \t]+)', '\n\n', new_content)
        
        # é è™•ç† Mermaid å€å¡Šï¼Œå°‡å…¶è½‰æ›ç‚º div ä»¥ä¾› mermaid.js æ¸²æŸ“
        mermaid_pattern = r"```mermaid\n(.*?)\n```"
        new_content = re.sub(mermaid_pattern, r'<div class="mermaid">\1</div>', new_content, flags=re.DOTALL)
        
        # è½‰æ› Markdown ç‚º HTML
        html_body = markdown.markdown(new_content, extensions=['tables', 'fenced_code', 'sane_lists'])
        
        output_file = output_dir / "index.html"
        output_file.write_text(html_body, encoding='utf-8')
        return output_file

class HTMLPackager:
    """
    è² è²¬å°‡åŸºç¤ HTML å°è£ç‚ºåŒ…å«æ¨£å¼èˆ‡ Meta è³‡è¨Šçš„å®Œæ•´ç¶²é ã€‚
    """
    def __init__(self, html_path: str):
        self.html_path = Path(html_path)
        if not self.html_path.exists():
            raise FileNotFoundError(f"æ‰¾ä¸åˆ° HTML æª”æ¡ˆï¼š{html_path}")
        self.content = self.html_path.read_text(encoding='utf-8')
        self.output_dir = self.html_path.parent

    def package(self, cover_image_name: str = None) -> Path:
        # 1. æ±ºå®šå°é¢åœ–ç‰‡
        cover_image = None
        if cover_image_name:
            if (self.output_dir / cover_image_name).exists():
                cover_image = cover_image_name
        
        if not cover_image:
            # è‡ªå‹•åµæ¸¬
            image_files = list(self.output_dir.glob('*.png')) + list(self.output_dir.glob('*.jpg')) + list(self.output_dir.glob('*.jpeg'))
            if image_files:
                cover_image = image_files[0].name
            else:
                cover_image = "cover.png"

        # 2. æå– Meta è³‡è¨Š
        # å˜—è©¦æå– H1 ä½œç‚ºæ¨™é¡Œ
        title_match = re.search(r'<h1.*?>(.*?)</h1>', self.content, re.DOTALL | re.IGNORECASE)
        if title_match:
            raw_title = title_match.group(1)
            title = re.sub(r'<.*?>', '', raw_title).strip()
        else:
            # è‹¥ç„¡ H1ï¼Œå˜—è©¦å¾ç›®éŒ„åç¨± (Slug) æ¨æ¸¬æ¨™é¡Œ
            slug = self.html_path.parent.name
            # ç§»é™¤æ™‚é–“æˆ³è¨˜ (ä¾‹å¦‚ _20260109_122218)
            clean_slug = re.sub(r'_\d{8}_\d{6}$', '', slug)
            # æ ¼å¼åŒ–æ¨™é¡Œ
            title = clean_slug.replace('-', ' ').replace('_', ' ').title()
            if not title.strip():
                title = "AI å±•æœ›å ±å‘Š"
        
        # å˜—è©¦æå–ç¬¬ä¸€æ®µæ–‡å­—ä½œç‚ºæè¿°
        desc_match = re.search(r'<p>(.*?)</p>', self.content)
        description = "å°ˆå®¶æ·±åº¦åˆ†æå ±å‘Š"
        if desc_match:
            clean_desc = re.sub(r'<.*?>', '', desc_match.group(1))
            description = clean_desc[:150] + "..." if len(clean_desc) > 150 else clean_desc

        # 3. æ³¨å…¥å°é¢åœ–ç‰‡ (åœ¨ H1 ä¹‹å¾Œï¼Œæˆ–æœ€å‰é¢)
        img_tag = f'<img src="{cover_image}" alt="Cover Image" style="width:100%; margin-bottom: 20px; border-radius: 8px;">'
        
        if '</h1>' in self.content:
            new_body = self.content.replace('</h1>', '</h1>\n' + img_tag, 1)
        else:
            new_body = img_tag + '\n' + self.content

        # 4. çµ„åˆæœ€çµ‚ HTML
        template = self._get_template(title, description, cover_image)
        final_html = template.replace("{CONTENT}", new_body)
        
        self.html_path.write_text(final_html, encoding='utf-8')
        return self.html_path

    def _get_template(self, title, description, cover_image):
        return f"""<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{title}</title>

<!-- Open Graph / LINE link preview -->
<meta property="og:title" content="{title}" />
<meta property="og:description" content="{description}" />
<meta property="og:type" content="article" />
<meta property="og:image" content="{cover_image}" />
<meta property="og:image:alt" content="Cover Image" />
<meta property="og:locale" content="zh_TW" />

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="{title}" />
<meta name="twitter:description" content="{description}" />
<meta name="twitter:image" content="{cover_image}" />

<!-- Additional SEO -->
<meta name="description" content="{description}" />

<link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<style>
    :root {{
        --transition-speed: 0.3s;
    }}
    body {{
        margin: 0;
        padding: 0;
        transition: background-color var(--transition-speed), color var(--transition-speed);
        line-height: 1.8;
    }}
    .container {{
        max-width: 900px;
        margin: 40px auto;
        padding: 40px;
        transition: all var(--transition-speed);
    }}
    img {{ max-width: 100%; height: auto; display: block; margin: 20px auto; border-radius: 8px; }}
    
    /* Theme Switcher */
    .theme-switch {{
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        gap: 10px;
        background: rgba(255,255,255,0.8);
        padding: 10px;
        border-radius: 50px;
        backdrop-filter: blur(5px);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }}
    .btn {{
        border: none;
        padding: 8px 16px;
        cursor: pointer;
        border-radius: 20px;
        font-weight: bold;
        font-family: inherit;
        transition: transform 0.2s;
    }}
    .btn:hover {{ transform: scale(1.05); }}

    /* Academic Theme */
    body.theme-academic {{
        background-color: #f4f4f4;
        color: #333;
        font-family: 'Lora', serif;
    }}
    body.theme-academic .container {{
        background-color: #fff;
        box-shadow: 0 0 15px rgba(0,0,0,0.05);
        border: 1px solid #ddd;
    }}
    body.theme-academic h1, body.theme-academic h2, body.theme-academic h3 {{
        color: #2c3e50;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }}
    body.theme-academic .btn {{ background: #e0e0e0; color: #333; }}
    body.theme-academic .btn.active {{ background: #2c3e50; color: #fff; }}

    /* Cute Theme */
    body.theme-cute {{
        background-color: #fff0f5;
        color: #5d4037;
        font-family: 'Quicksand', sans-serif;
        background-image: radial-gradient(#ffb7b2 1px, transparent 1px);
        background-size: 20px 20px;
    }}
    body.theme-cute .container {{
        background-color: #ffffff;
        border-radius: 25px;
        border: 3px dashed #ffb7b2;
        box-shadow: 0 10px 20px rgba(255, 183, 178, 0.3);
    }}
    body.theme-cute h1, body.theme-cute h2 {{
        color: #ff6b6b;
        text-shadow: 2px 2px 0px #ffd1dc;
    }}
    body.theme-cute blockquote {{
        border-left: 5px solid #ffb7b2;
        background-color: #fff9fa;
        padding: 10px 20px;
        border-radius: 10px;
    }}
    body.theme-cute .btn {{ background: #ffe0e6; color: #ff6b6b; }}
    body.theme-cute .btn.active {{ background: #ff6b6b; color: #fff; }}
    
    /* Mermaid */
    .mermaid {{ text-align: center; margin: 30px 0; }}

    /* RWD */
    @media (max-width: 768px) {{
        .container {{ padding: 20px; margin: 20px auto; width: 90%; }}
        .theme-switch {{ top: auto; bottom: 20px; right: 20px; }}
    }}
</style>
</head>
<body class="theme-academic">

<div class="theme-switch">
    <button class="btn active" onclick="setTheme('academic', this)">ğŸ“ å­¸è¡“æ¨¡å¼</button>
    <button class="btn" onclick="setTheme('cute', this)">ğŸ§¸ å¯æ„›æ¨¡å¼</button>
</div>

<div class="container">
    {{CONTENT}}
</div>

<script>
    mermaid.initialize({{startOnLoad:true}});
    
    function setTheme(themeName, btn) {{
        document.body.className = 'theme-' + themeName;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }}
</script>
</body>
</html>"""

@app.command()
def summary(file_path: str = "output/new-year-special-hopes-for-2026-from-david-cox-adj_20260107_083339.md"):
    """é¡¯ç¤ºå ±å‘Šçš„åŸ·è¡Œæ‘˜è¦ã€‚"""
    try:
        conductor = ReportConductor(file_path)
        summary_text = conductor.get_summary()
        console.print(Panel(Markdown(summary_text), title="ğŸ“‹ å ±å‘Šæ‘˜è¦", border_style="green"))
    except Exception as e:
        console.print(f"[red]éŒ¯èª¤: {e}[/red]")

@app.command()
def experts(file_path: str = "output/new-year-special-hopes-for-2026-from-david-cox-adj_20260107_083339.md"):
    """åˆ—å‡ºè²¢ç»å ±å‘Šçš„å°ˆå®¶ã€‚"""
    try:
        conductor = ReportConductor(file_path)
        experts_list = conductor.list_experts()
        console.print(Panel("\n".join([f"â€¢ {name}" for name in experts_list]), title="ğŸ”¬ è²¢ç»å°ˆå®¶", border_style="blue"))
    except Exception as e:
        console.print(f"[red]éŒ¯èª¤: {e}[/red]")

@app.command()
def diagrams(file_path: str = "output/new-year-special-hopes-for-2026-from-david-cox-adj_20260107_083339.md", export: bool = False):
    """æå– Mermaid åœ–è¡¨ã€‚ä½¿ç”¨ --export å„²å­˜ç‚ºæª”æ¡ˆã€‚"""
    try:
        conductor = ReportConductor(file_path)
        charts = conductor.extract_mermaid_charts()
        
        console.print(f"æ‰¾åˆ° {len(charts)} å€‹ Mermaid åœ–è¡¨ã€‚")
        
        for i, chart in enumerate(charts, 1):
            if export:
                output_file = Path(f"diagram_{i}.mmd")
                output_file.write_text(chart, encoding='utf-8')
                console.print(f"å·²å„²å­˜: {output_file}")
            else:
                console.print(Panel(chart, title=f"åœ–è¡¨ {i}", border_style="yellow"))
    except Exception as e:
        console.print(f"[red]éŒ¯èª¤: {e}[/red]")

@app.command()
def actions(file_path: str = "output/new-year-special-hopes-for-2026-from-david-cox-adj_20260107_083339.md"):
    """é¡¯ç¤ºå»ºè­°çš„ä¸‹ä¸€æ­¥è¡Œå‹•ã€‚"""
    try:
        conductor = ReportConductor(file_path)
        actions_text = conductor.get_action_items()
        console.print(Panel(Markdown(actions_text), title="ğŸš€ ä¸‹ä¸€æ­¥è¡Œå‹•", border_style="red"))
    except Exception as e:
        console.print(f"[red]éŒ¯èª¤: {e}[/red]")

@app.command()
def convert(file_path: str, slug: str):
    """ç¨‹å¼ä¸€ï¼šå°‡ Markdown è½‰æ›ç‚ºåŸºç¤ HTML ä¸¦é›†ä¸­åœ–ç‰‡è³‡æºã€‚"""
    try:
        conductor = ReportConductor(file_path)
        output_file = conductor.convert_to_folder(slug)
        console.print(f"[green]âœ¨ è½‰æ›å®Œæˆ: {output_file}[/green]")
        console.print(f"[blue]åœ–ç‰‡å·²è¤‡è£½åˆ°: {output_file.parent}[/blue]")
    except Exception as e:
        console.print(f"[red]éŒ¯èª¤: {e}[/red]")

@app.command()
def package(html_path: str, cover: str = typer.Option(None, help="è‡ªè¨‚å°é¢åœ–ç‰‡æª”å")):
    """ç¨‹å¼äºŒï¼šå°è£ HTMLï¼Œæ³¨å…¥æ¨£å¼ã€å°é¢åœ–èˆ‡ Meta æ¨™ç±¤ã€‚"""
    try:
        packager = HTMLPackager(html_path)
        final_file = packager.package(cover_image_name=cover)
        console.print(f"[green]âœ¨ å°è£å®Œæˆ: {final_file}[/green]")
    except Exception as e:
        console.print(f"[red]éŒ¯èª¤: {e}[/red]")

if __name__ == "__main__":
    app()
