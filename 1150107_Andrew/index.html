import re
from pathlib import Path
from typing import List
import typer
import markdown
from rich.console import Console
from rich.markdown import Markdown
from rich.panel import Panel

app = typer.Typer()
console = Console()

class ReportConductor:
    """
    è² è²¬è™•ç† AI 2026 å±•æœ›å ±å‘Šçš„é¡åˆ¥ã€‚
    """
    def __init__(self, file_path: str):
        self.file_path = Path(file_path)
        if not self.file_path.exists():
            raise FileNotFoundError(f"æ‰¾ä¸åˆ°å ±å‘Šæª”æ¡ˆï¼š{file_path}")
        self.content = self.file_path.read_text(encoding='utf-8')

    def get_summary(self) -> str:
        """æå–åŸ·è¡Œæ‘˜è¦å€å¡Šã€‚"""
        pattern = r"## ğŸ“‹ å ±å‘Šæ‘˜è¦\n\n(.*?)\n---"
        match = re.search(pattern, self.content, re.DOTALL)
        return match.group(1).strip() if match else "æœªæ‰¾åˆ°æ‘˜è¦ã€‚"

    def extract_mermaid_charts(self) -> List[str]:
        """æå–æ‰€æœ‰ Mermaid åœ–è¡¨å®šç¾©ã€‚"""
        pattern = r"```mermaid\n(.*?)\n```"
        return re.findall(pattern, self.content, re.DOTALL)

    def list_experts(self) -> List[str]:
        """æå–ä»‹ç´¹ä¸­æåˆ°çš„å°ˆå®¶å§“åã€‚"""
        pattern = r"Hopes for 2026 from (.*?)\""
        match = re.search(pattern, self.content)
        if match:
            raw_names = match.group(1).split(',')
            return [name.strip() for name in raw_names]
        return []

    def get_action_items(self) -> str:
        """æå–ä¸‹ä¸€æ­¥è¡Œå‹•å»ºè­°ã€‚"""
        pattern = r"\*\*ä¸‹ä¸€æ­¥è¡Œå‹•\*\*:(.*?)\n---"
        match = re.search(pattern, self.content, re.DOTALL)
        return match.group(1).strip() if match else "æœªæ‰¾åˆ°è¡Œå‹•å»ºè­°ã€‚"

    def render_html(self, cover_image: str = "cover.png") -> str:
        """å°‡å ±å‘Šè½‰æ›ç‚ºå…·æœ‰ä¸»é¡Œåˆ‡æ›åŠŸèƒ½çš„ç¨ç«‹ HTMLã€‚"""
        # é è™•ç† Mermaid å€å¡Šï¼Œå°‡å…¶è½‰æ›ç‚º div ä»¥ä¾› mermaid.js æ¸²æŸ“
        content = self.content
        mermaid_pattern = r"```mermaid\n(.*?)\n```"
        content = re.sub(mermaid_pattern, r'<div class="mermaid">\1</div>', content, flags=re.DOTALL)
        
        # è½‰æ› Markdown ç‚º HTML
        html_body = markdown.markdown(content, extensions=['tables', 'fenced_code'])
        
        # æ’å…¥å°é¢åœ–ç‰‡
        html_body = html_body.replace(
            '<h2>ğŸ“‹ å ±å‘Šæ‘˜è¦</h2>', 
            f'<img src="{cover_image}" alt="Cover Image" style="width:100%; margin-bottom: 20px; border-radius: 8px;">\n<h2>ğŸ“‹ å ±å‘Šæ‘˜è¦</h2>'
        )
        
        template = """<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2026 AI å±•æœ›å ±å‘Š</title>

<!-- Open Graph / LINE link preview -->
<meta property="og:title" content="2026 AI å±•æœ›å ±å‘Š" />
<meta property="og:description" content="å°ˆå®¶æ·±åº¦åˆ†æå ±å‘Šï¼šåŒ¯é›†å¤šä½ AI é ˜åŸŸé ‚å°–å°ˆå®¶å° 2026 å¹´ AI ç™¼å±•çš„é æœŸèˆ‡æ´è¦‹ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:image" content="{{COVER_IMAGE}}" />
<meta property="og:image:alt" content="2026 AI Outlook Report Cover" />
<meta property="og:locale" content="zh_TW" />

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="2026 AI å±•æœ›å ±å‘Š" />
<meta name="twitter:description" content="å°ˆå®¶æ·±åº¦åˆ†æå ±å‘Šï¼šåŒ¯é›†å¤šä½ AI é ˜åŸŸé ‚å°–å°ˆå®¶å° 2026 å¹´ AI ç™¼å±•çš„é æœŸèˆ‡æ´è¦‹ã€‚" />
<meta name="twitter:image" content="{{COVER_IMAGE}}" />

<!-- Additional SEO -->
<meta name="description" content="2026 AI å±•æœ›å ±å‘Šï¼šæ¶µè“‹ AGI æ¸¬è©¦ã€ç§‘å­¸ç™¼ç¾ã€æ•™è‚²è½‰å‹åŠç‰©ç† AI çš„ç”¢æ¥­æ‡‰ç”¨ã€‚" />

<link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<style>
    :root {
        --transition-speed: 0.3s;
    }
    body {
        margin: 0;
        padding: 0;
        transition: background-color var(--transition-speed), color var(--transition-speed);
        line-height: 1.8;
    }
    .container {
        max-width: 900px;
        margin: 40px auto;
        padding: 40px;
        transition: all var(--transition-speed);
    }
    img { max-width: 100%; height: auto; display: block; margin: 20px auto; border-radius: 8px; }
    
    /* Theme Switcher */
    .theme-switch {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        gap: 10px;
        background: rgba(255,255,255,0.8);
        padding: 10px;
        border-radius: 50px;
        backdrop-filter: blur(5px);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .btn {
        border: none;
        padding: 8px 16px;
        cursor: pointer;
        border-radius: 20px;
        font-weight: bold;
        font-family: inherit;
        transition: transform 0.2s;
    }
    .btn:hover { transform: scale(1.05); }

    /* Academic Theme */
    body.theme-academic {
        background-color: #f4f4f4;
        color: #333;
        font-family: 'Lora', serif;
    }
    body.theme-academic .container {
        background-color: #fff;
        box-shadow: 0 0 15px rgba(0,0,0,0.05);
        border: 1px solid #ddd;
    }
    body.theme-academic h1, body.theme-academic h2, body.theme-academic h3 {
        color: #2c3e50;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }
    body.theme-academic .btn { background: #e0e0e0; color: #333; }
    body.theme-academic .btn.active { background: #2c3e50; color: #fff; }

    /* Cute Theme */
    body.theme-cute {
        background-color: #fff0f5;
        color: #5d4037;
        font-family: 'Quicksand', sans-serif;
        background-image: radial-gradient(#ffb7b2 1px, transparent 1px);
        background-size: 20px 20px;
    }
    body.theme-cute .container {
        background-color: #ffffff;
        border-radius: 25px;
        border: 3px dashed #ffb7b2;
        box-shadow: 0 10px 20px rgba(255, 183, 178, 0.3);
    }
    body.theme-cute h1, body.theme-cute h2 {
        color: #ff6b6b;
        text-shadow: 2px 2px 0px #ffd1dc;
    }
    body.theme-cute blockquote {
        border-left: 5px solid #ffb7b2;
        background-color: #fff9fa;
        padding: 10px 20px;
        border-radius: 10px;
    }
    body.theme-cute .btn { background: #ffe0e6; color: #ff6b6b; }
    body.theme-cute .btn.active { background: #ff6b6b; color: #fff; }
    
    /* Mermaid */
    .mermaid { text-align: center; margin: 30px 0; }

    /* RWD */
    @media (max-width: 768px) {
        .container { padding: 20px; margin: 20px auto; width: 90%; }
        .theme-switch { top: auto; bottom: 20px; right: 20px; }
    }
</style>
</head>
<body class="theme-academic">

<div class="theme-switch">
    <button class="btn active" onclick="setTheme('academic', this)">ğŸ“ å­¸è¡“æ¨¡å¼</button>
    <button class="btn" onclick="setTheme('cute', this)">ğŸ§¸ å¯æ„›æ¨¡å¼</button>
</div>

<div class="container">
    {{CONTENT}}
</div>

<script>
    mermaid.initialize({startOnLoad:true});
    
    function setTheme(themeName, btn) {
        document.body.className = 'theme-' + themeName;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
</script>
</body>
</html>"""
        return template.replace("{{CONTENT}}", html_body).replace("{{COVER_IMAGE}}", cover_image)

@app.command()
def summary(file_path: str = "output/new-year-special-hopes-for-2026-from-david-cox-adj_20260107_083339.md"):
    """é¡¯ç¤ºå ±å‘Šçš„åŸ·è¡Œæ‘˜è¦ã€‚"""
    try:
        conductor = ReportConductor(file_path)
        summary_text = conductor.get_summary()
        console.print(Panel(Markdown(summary_text), title="ğŸ“‹ å ±å‘Šæ‘˜è¦", border_style="green"))
    except Exception as e:
        console.print(f"[red]éŒ¯èª¤: {e}[/red]")

@app.command()
def experts(file_path: str = "output/new-year-special-hopes-for-2026-from-david-cox-adj_20260107_083339.md"):
    """åˆ—å‡ºè²¢ç»å ±å‘Šçš„å°ˆå®¶ã€‚"""
    try:
        conductor = ReportConductor(file_path)
        experts_list = conductor.list_experts()
        console.print(Panel("\n".join([f"â€¢ {name}" for name in experts_list]), title="ğŸ”¬ è²¢ç»å°ˆå®¶", border_style="blue"))
    except Exception as e:
        console.print(f"[red]éŒ¯èª¤: {e}[/red]")

@app.command()
def diagrams(file_path: str = "output/new-year-special-hopes-for-2026-from-david-cox-adj_20260107_083339.md", export: bool = False):
    """æå– Mermaid åœ–è¡¨ã€‚ä½¿ç”¨ --export å„²å­˜ç‚ºæª”æ¡ˆã€‚"""
    try:
        conductor = ReportConductor(file_path)
        charts = conductor.extract_mermaid_charts()
        
        console.print(f"æ‰¾åˆ° {len(charts)} å€‹ Mermaid åœ–è¡¨ã€‚")
        
        for i, chart in enumerate(charts, 1):
            if export:
                output_file = Path(f"diagram_{i}.mmd")
                output_file.write_text(chart, encoding='utf-8')
                console.print(f"å·²å„²å­˜: {output_file}")
            else:
                console.print(Panel(chart, title=f"åœ–è¡¨ {i}", border_style="yellow"))
    except Exception as e:
        console.print(f"[red]éŒ¯èª¤: {e}[/red]")

@app.command()
def actions(file_path: str = "output/new-year-special-hopes-for-2026-from-david-cox-adj_20260107_083339.md"):
    """é¡¯ç¤ºå»ºè­°çš„ä¸‹ä¸€æ­¥è¡Œå‹•ã€‚"""
    try:
        conductor = ReportConductor(file_path)
        actions_text = conductor.get_action_items()
        console.print(Panel(Markdown(actions_text), title="ğŸš€ ä¸‹ä¸€æ­¥è¡Œå‹•", border_style="red"))
    except Exception as e:
        console.print(f"[red]éŒ¯èª¤: {e}[/red]")

@app.command()
def html(file_path: str = "output/new-year-special-hopes-for-2026-from-david-cox-adj_20260107_083339.md", output: str = "output/html/index.html"):
    """å°‡å ±å‘Šè½‰æ›ç‚º HTML æª”æ¡ˆï¼ŒåŒ…å«å­¸è¡“/å¯æ„›é¢¨æ ¼åˆ‡æ›ã€‚"""
    try:
        conductor = ReportConductor(file_path)
        output_path = Path(output)
        output_path.parent.mkdir(parents=True, exist_ok=True)
        
        # è‡ªå‹•åµæ¸¬åŒç›®éŒ„ä¸‹çš„ PNG æª”æ¡ˆ
        png_files = list(output_path.parent.glob('*.png'))
        cover_image = png_files[0].name if png_files else "cover.png"
        
        html_content = conductor.render_html(cover_image=cover_image)
        output_path.write_text(html_content, encoding='utf-8')
        console.print(f"[green]âœ¨ æˆåŠŸç”Ÿæˆ HTML å ±å‘Š: {output}[/green]")
    except Exception as e:
        console.print(f"[red]éŒ¯èª¤: {e}[/red]")

if __name__ == "__main__":
    app()
